<script>
(function(){
  function openPdf(absUrl){
    const m=document.getElementById('modal');
    const box=document.getElementById('modalBox');
    box.innerHTML = '<object data="'+absUrl+'#view=FitH" type="application/pdf" width="100%" height="100%">' +
                    '<p style="padding:16px">PDFを開けませんでした。<a href="'+absUrl+'" target="_blank" rel="noopener">新しいタブで開く</a></p>' +
                    '</object>';
    m.style.display='block';
  }
  function closePdf(){
    const m=document.getElementById('modal');
    const box=document.getElementById('modalBox');
    m.style.display='none';
    box.innerHTML='';
  }

  function resolveAbsoluteUrl(href){
    // a要素に解決させるのが最も確実（baseurl二重付与を防ぐ）
    const a=document.createElement('a');
    a.href = href;
    return a.href;
  }

  // iOSや一部Safariは埋め込みが不安定 → 新規タブに逃がす
  function shouldOpenInNewTab(){
    const ua = navigator.userAgent;
    return /iPhone|iPad|iPod/.test(ua) || (/Safari/.test(ua) && !/Chrome/.test(ua) && /Mac OS X/.test(ua));
  }

  function attach(){
    document.querySelectorAll('a[data-pdf], a[data-modal="pdf"], a.pdf-link').forEach(a=>{
      if(a._pdfBound) return; a._pdfBound = true;
      a.addEventListener('click', function(e){
        const raw = this.getAttribute('data-pdf') || this.getAttribute('href');
        if(!raw) return;
        const abs = resolveAbsoluteUrl(raw);
        e.preventDefault();
        if (shouldOpenInNewTab()){
          window.open(abs, '_blank', 'noopener');
        } else {
          openPdf(abs);
        }
      });
    });
  }

  attach();
  document.getElementById('modalClose').addEventListener('click', closePdf);
  document.getElementById('modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') closePdf(); });
  new MutationObserver(attach).observe(document.body,{childList:true,subtree:true});
})();
</script>
