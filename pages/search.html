---
layout: default
title: 検索
permalink: /pages/search.html
---

<h2>サイト内検索</h2>

<div class="card" style="margin-bottom:16px;">
  <input id="q" type="search" placeholder="キーワード（例：給食 無償化 / 不登校 / 免許）"
         style="width:100%; padding:12px 14px; border:1px solid #ddd; border-radius:12px;">
  <div id="meta" style="margin-top:6px;color:#666;"></div>
</div>

<div id="results" class="grid" role="list"
     style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;"></div>

<script>
(function(){
  const base='{{ site.baseurl | default: "" }}';
  const qEl=document.getElementById('q'), meta=document.getElementById('meta'), res=document.getElementById('results');

  /* 日本語に強い正規化 */
  const normalizeJa = s => (s||'')
    .toString()
    .toLowerCase()
    .normalize('NFKC')                                   // 全角→半角
    .replace(/[ぁ-ん]/g,ch => String.fromCharCode(ch.charCodeAt(0)+0x60)) // ひら→カタ
    .replace(/[^a-z0-9\u30A0-\u30FF\u4E00-\u9FFF]/g,''); // 記号除去

  const tokenize = s => (s||'').trim().split(/[\s　]+/).filter(Boolean);

  const highlight = (txt, terms) =>
    terms.reduce((r,t)=>r.replace(new RegExp('('+t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','ig'),'<mark>$1</mark>'), txt);

  /* スコア：1語でも当たれば採用。タイトル重み3、本文1 */
  function score(doc, terms){
    const T = normalizeJa(doc.title);
    const X = normalizeJa(doc.text);
    let s = 0, hit = false;
    for(const raw of terms){
      const t = normalizeJa(raw);
      if(!t) continue;
      if(T.includes(t)){ s += 3; hit = true; }
      else if(X.includes(t)){ s += 1; hit = true; }
    }
    return hit ? s : -1;
  }

  function card(doc, terms){
    const pdf = (doc.url && /\.pdf$/i.test(doc.url)) ? doc.url : null;
    const page = pdf ? (base + '/pages/activity.html') : (doc.url.startsWith('/') ? doc.url : (base + doc.url));
    return `<article class="card">
      <h3>[${doc.type}] ${highlight(doc.title,terms)}</h3>
      <p style="color:#666">${doc.date||''}</p>
      <p>${highlight(doc.text||'',terms)}</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        ${pdf ? `<a class="btn btn-primary" href="${pdf}">PDFを開く</a>` : ``}
        <a class="btn" href="${page}">該当ページ</a>
      </div>
    </article>`;
  }

  let INDEX = null;

  async function ensureIndex(){
    if(INDEX) return INDEX;
    const url = (base || '') + '/search.json';
    const r = await fetch(url, {cache:'no-store'});
    if(!r.ok) throw new Error('search.json を取得できません');
    INDEX = await r.json();
    return INDEX;
  }

  async function run(q){
    const idx = await ensureIndex();
    const docs = idx.docs || [];
    const terms = tokenize(q);
    if(!terms.length){
      meta.textContent = `検索対象：${docs.length}件（キーワードを入力してください）`;
      res.innerHTML = '';
      return;
    }
    const hits = docs.map(d => ({d, s: score(d, terms)}))
                     .filter(x => x.s >= 0)
                     .sort((a,b) => b.s - a.s);

    if(hits.length){
      meta.textContent = `「${q}」の結果：${hits.length}件`;
      res.innerHTML = hits.map(h => card(h.d, terms)).join('');
    }else{
      meta.innerHTML = `「${q}」に一致する項目は見つかりません。`;
      res.innerHTML = `<p style="color:#888;">
        <strong>表記ゆらぎの可能性</strong>：全角/半角、ひらがな/カタカナ、旧字体・略称などをお試しください。<br>
        例）<code>ふとうこう → 不登校</code>、<code>AC → エアコン</code>
      </p>`;
    }
  }

  let timer=null;
  qEl.addEventListener('input', ()=>{
    clearTimeout(timer);
    timer = setTimeout(()=>run(qEl.value), 150);
  });

  /* 初期表示：総件数 */
  ensureIndex().then(idx=>{
    meta.textContent = `検索対象：${(idx.docs||[]).length}件`;
  }).catch(e=>{
    meta.textContent = '検索インデックスの読み込みに失敗しました。';
    console.error(e);
  });
})();
</script>
