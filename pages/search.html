---
layout: default
title: 検索
permalink: /pages/search.html
---

<h2>サイト内検索</h2>

<div class="card" style="margin-bottom:16px;">
  <input id="q" type="search" placeholder="キーワードを入力（例：給食 無償化 / 不登校 / 免許）"
         style="width:100%; padding:12px 14px; border:1px solid #ddd; border-radius:12px;">
  <div id="meta" style="margin-top:6px;color:#666;"></div>
</div>

<div id="results" class="grid" role="list"
     style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;"></div>

<script>
(function(){
  const base='{{ site.baseurl | default: "" }}';

  /* Liquid側データを安全に展開（未定義対策） */
  {% assign P0 = site.data.promises.promises | default: site.data.promises | default: [] %}
  {% assign A0 = site.data.activity.items   | default: site.data.activity | default: [] %}
  {% assign M0 = site.data.matrix.rows      | default: site.data.matrix.categories | default: site.data.matrix | default: [] %}

  const P={{ P0 | jsonify }};
  const A={{ A0 | jsonify }};
  const M={{ M0 | jsonify }};

  const DATA=[]
    .concat((Array.isArray(P)?P:[]).map(p=>({
      type:'公約', title:p.title||'', text:(p.detail||p.desc||'')+' '+(p.status||''), date:p.last_update||'',
      url:base+'/pages/promise.html', pdf:p.pdf?new URL(p.pdf,location.origin+base+'/').pathname:null
    })))
    .concat((Array.isArray(A)?A:[]).map(a=>({
      type:'活動', title:a.title||'', text:(a.summary||a.text||'')+' '+(a.category||''), date:a.date||'',
      url:base+'/pages/activity.html', pdf:a.pdf?new URL(a.pdf,location.origin+base+'/').pathname:null
    })))
    .concat((Array.isArray(M)?M:[]).flatMap(m=>{
      if(m.category){
        const t=(m.sakio||[]).map(x=>x.title||x).join(' ')+' '+(m.related||[]).map(x=>x.title||x).join(' ');
        return [{
          type:'一般質問', title:m.category, text:t, date:m.date||'',
          url:base+'/pages/matrix.html', pdf:m.pdf?new URL(m.pdf,location.origin+base+'/').pathname:null
        }];
      }
      return [];
    }));

  const qEl=document.getElementById('q'), meta=document.getElementById('meta'), res=document.getElementById('results');

  /* ▼ 日本語対応 正規化関数 */
  const norm=s=>{
    return (s||'')
      .toString()
      .toLowerCase()
      .normalize('NFKC')              // 全角→半角、濁点結合解除
      .replace(/[ぁ-ん]/g,m=>String.fromCharCode(m.charCodeAt(0)+0x60)) // ひら→カタ
      .replace(/[^a-z0-9\u30A0-\u30FF\u4E00-\u9FFF]/g,'');              // 記号削除
  };

  /* トークン化：スペース区切り＋単語リスト */
  const tok=s=>(s||'').trim().split(/[\\s　]+/).filter(Boolean);

  /* 部分一致ハイライト */
  const hl=(txt,ts)=>ts.reduce((r,t)=>r.replace(new RegExp('('+t.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\\\$&')+')','ig'),'<mark>$1</mark>'), txt);

  /* スコアリング：1語でも一致すればOK */
  function score(it,ts){
    let T=norm(it.title),X=norm(it.text),s=0,hit=false;
    for(const t0 of ts){
      const t=norm(t0);
      if(T.includes(t)||X.includes(t)){
        s+=(T.includes(t)?3:1);
        hit=true;
      }
    }
    return hit?s:-1;
  }

  function card(it,ts){
    return `<article class="card">
      <h3>[${it.type}] ${hl(it.title,ts)}</h3>
      <p style="color:#666">${it.date||''}</p>
      <p>${hl(it.text||'',ts)}</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        ${it.pdf?`<a class="btn btn-primary pdf-link" href=\"${it.pdf}\">PDFを開く</a>`:''}
        <a class="btn" href=\"${it.url}\">該当ページ</a>
      </div>
    </article>`;
  }

  function run(q){
    const ts=tok(q);
    if(!ts.length){
      meta.textContent=`データ件数：${DATA.length}`;
      res.innerHTML='';
      return;
    }
    const hits=DATA.map(it=>({it,s:score(it,ts)}))
                   .filter(x=>x.s>=0)
                   .sort((a,b)=>b.s-a.s);
    if(hits.length){
      meta.textContent=`「${q}」の結果：${hits.length}件`;
      res.innerHTML=hits.map(h=>card(h.it,ts)).join('');
    }else{
      meta.textContent=`「${q}」に一致する項目は見つかりません。`;
      res.innerHTML=`<p style='color:#888;'>表記ゆらぎ（例：全角・半角、ひらがな／カタカナ等）をご確認ください。</p>`;
    }
  }

  let timer;
  qEl.addEventListener('input',()=>{
    clearTimeout(timer);
    timer=setTimeout(()=>run(qEl.value),150);
  });
})();
</script>

