---
layout: default
title: 検索
permalink: /pages/search.html
---

<div class="container" style="max-width:960px;margin:2rem auto;">
  <h1 style="margin-bottom:1rem;">サイト内検索</h1>

  <label for="search-input" style="display:block;font-weight:600;margin-bottom:.5rem;">キーワード</label>
  <input id="search-input" type="search" placeholder="例）給食 / 三和小 / eスポーツ / 公約 …"
         style="width:100%;padding:.75rem 1rem;border:1px solid #ddd;border-radius:.5rem;font-size:1rem;">

  <div id="search-meta" style="margin:.75rem 0;color:#666;font-size:.9rem;"></div>

  <div id="search-results" style="display:grid;gap:12px;margin-top:1rem;"></div>
</div>

<script>
(() => {
  const baseurl = "{{ site.baseurl }}";
  const INDEX_URL = (baseurl + "/search.json").replace(/\/+/g, "/");

  const $input   = document.getElementById("search-input");
  const $meta    = document.getElementById("search-meta");
  const $results = document.getElementById("search-results");

  let INDEX = [];
  let ready = false;

  // --- Utility: normalize text (simple, Japanese-safe) ---
  const norm = (s) => (s || "").toString().toLowerCase();

  // --- Fetch index once ---
  fetch(INDEX_URL, { cache: "no-store" })
    .then(r => {
      if (!r.ok) throw new Error("search.json not found: " + r.status);
      return r.json();
    })
    .then(json => {
      INDEX = Array.isArray(json) ? json : [];
      ready = true;
      $meta.textContent = `インデックス読み込み完了（${INDEX.length}件）`;
    })
    .catch(err => {
      ready = false;
      console.error(err);
      $meta.textContent = "検索インデックスの読み込みに失敗しました。開発者ツールのConsole/Networkをご確認ください。";
    });

  // --- Render helpers ---
  function highlight(text, query) {
    if (!query) return text;
    try {
      const esc = query.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      return text.replace(new RegExp(esc, "gi"), m => `<mark>${m}</mark>`);
    } catch {
      return text;
    }
  }

  function render(items, query) {
    $results.innerHTML = "";
    if (!items.length) {
      $results.innerHTML = `<div style="color:#666;">該当なし</div>`;
      return;
    }
    const frag = document.createDocumentFragment();
    items.forEach(it => {
      const card = document.createElement("article");
      card.style.cssText = "border:1px solid #eee;border-radius:12px;padding:14px 16px;";
      const tags = []
        .concat(Array.isArray(it.categories) ? it.categories : [])
        .concat(Array.isArray(it.tags) ? it.tags : []);
      card.innerHTML = `
        <h3 style="margin:0 0 6px 0;font-size:1.05rem;">
          <a href="${it.url}" style="text-decoration:none;">${highlight(it.title, query)}</a>
        </h3>
        <div style="color:#666;font-size:.88rem;margin-bottom:6px;">${it.date || ""}</div>
        ${tags.length ? `<div style="margin-bottom:6px;font-size:.85rem;color:#444;">${tags.map(t=>`#${t}`).join(" ")}</div>` : ""}
        <p style="margin:0;color:#333;font-size:.95rem;line-height:1.6;">
          ${highlight((it.excerpt || "").toString(), query)}
        </p>
      `;
      frag.appendChild(card);
    });
    $results.appendChild(frag);
  }

  // --- Search (simple substring across title/excerpt/content) ---
  function search(q) {
    const qn = norm(q).trim();
    if (!qn) {
      $meta.textContent = ready ? `キーワードを入力してください（${INDEX.length}件の候補）` : "インデックス読込中…";
      $results.innerHTML = "";
      return;
    }
    // AND検索（空白区切りすべて含む）
    const tokens = qn.split(/\s+/).filter(Boolean);
    const items = INDEX.filter(it => {
      const hay = norm([it.title, it.excerpt, it.content].join(" "));
      return tokens.every(tok => hay.includes(tok));
    }).slice(0, 200); // 念のため上限
    $meta.textContent = `「${q}」の検索結果：${items.length}件`;
    render(items, q);
  }

  // --- Debounce input ---
  let timer = null;
  $input.addEventListener("input", (e) => {
    clearTimeout(timer);
    timer = setTimeout(() => search(e.target.value), 160);
  });

  // クエリ文字列 ?q=... で事前検索
  const params = new URLSearchParams(location.search);
  const q0 = params.get("q") || "";
  if (q0) {
    $input.value = q0;
    const wait = setInterval(() => {
      if (ready) { clearInterval(wait); search(q0); }
    }, 60);
  }
})();
</script>
