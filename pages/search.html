---
layout: default
title: 検索
permalink: /pages/search.html
---

<h2>サイト内検索</h2>

<div class="card" style="margin-bottom:16px;">
  <input id="q" type="search" placeholder="キーワードを入力（例：給食 無償化 / 不登校 / 免許）"
         style="width:100%; padding:12px 14px; border:1px solid #ddd; border-radius:12px;">
  <div id="meta" style="margin-top:6px;color:#666;"></div>

  <!-- ▼ 追加：検索の仕様・コツを目に入る位置に -->
  <p class="search-note">
    ※ 日本語は語形分割をしていないため、<strong>表記が違うとヒットしにくい</strong>です。<br>
    例）「学校給食」ではなく <strong>「給食」</strong> などの短い語に分け、<strong>スペースで AND 検索</strong>してください。
  </p>
</div>

<script>
  // ▼ 文字列か配列かを安全に配列化
const toArr = (v) => Array.isArray(v) ? v : (v == null ? [] : [v]);

// ▼ タグ候補を一気に吸収（null安全）し、「、 ・ / ,」やスペースで分割
const gatherTagCandidates = (...vals) => {
  const raw = vals.flatMap(toArr).filter(v => v != null).map(v => String(v));
  const pieces = raw.flatMap(s => s
    .replace(/\u3000/g, ' ')            // 全角→半角スペース
    .split(/[,\s/・、]+/)               // カンマ/スペース/スラッシュ/中点/読点で分割
  );
  return pieces;
};

// ▼ 正規化：トリム→空除去→重複排除
const normalizeTags = (vals) => {
  const out = [];
  const seen = new Set();
  for (const t of gatherTagCandidates(vals)) {
    const z = t.trim();
    if (!z) continue;
    if (seen.has(z)) continue;
    seen.add(z);
    out.push(z);
  }
  return out;
};

// ▼ baseurl 付与（PDF 404対策）
const withBase = (p) => {
  const base = '{{ site.baseurl | default: "" }}';
  if (!p) return null;
  if (/^https?:\/\//i.test(p)) return p;
  if (p.startsWith(base + '/')) return p;
  if (p.startsWith('/')) return base + p;
  return base + '/' + p.replace(/^\.\//,'');
};

// ▼ デバッグ（必要時 F12 で window.__debugTags() 実行）
window.__debugTags = (items) => {
  const all = items.flatMap(it => it.tags || []);
  const map = {};
  for (const t of all) map[t] = (map[t]||0) + 1;
  console.table(map);
  return map;
};

(function(){
  const base='{{ site.baseurl | default: "" }}';

  /* ===== Liquid → JS: 一重jsonifyだけ ===== */
  {% assign P0 = site.data.promises.promises | default: site.data.promises %}
  {% assign A0 = site.data.activity.items   | default: site.data.activity %}
  {% assign M0 = site.data.matrix.rows      | default: site.data.matrix.categories | default: site.data.matrix %}

  const P = {{ P0 | jsonify }};
  const A = {{ A0 | jsonify }};
  const M = {{ M0 | jsonify }};

  /* _posts を配列化（strip_html だけ、normalize_whitespace は使わない） */
  const POSTS = [
    {% for post in site.posts %}
    {
      "title": {{ post.title | jsonify }},
      "url":   "{{ post.url | relative_url }}",
      "content": {{ post.content | strip_html | jsonify }},
      "date":  "{{ post.date | date: '%Y-%m-%d' }}",
      "tags":  {{ post.tags | jsonify }},
      "categories": {{ post.categories | jsonify }}
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];
// 追加：タグ正規化ヘルパー（全角空白→半角、トリム、空要素除去、重複排除）
const normalizeTags = (list) => {
  const arr = (Array.isArray(list) ? list : (list ? [list] : []))
    .map(t => (t ?? '').toString().replace(/\u3000/g,' ').replace(/\s+/g,' ').trim())
    .filter(Boolean);
  return [...new Set(arr)];
};
// 置換：DATA 生成内の「活動」ブロック
.concat(arr(A).map(a=>({
  type:'活動',
  title:a.title||'',
  text:`${a.summary||''} ${a.category||''}`,
  date:a.date||'',
  url: base + '/pages/activity.html',
  pdf: withBase(a.pdf || null),
  // ▼ tag / tags / category を統合して正規化
  tags: normalizeTags([...(a.tags||[]), ...(a.tag||[]), a.category||''])
})))

  /* ===== DOM参照 ===== */
  const qEl  = document.getElementById('q');
  const meta = document.getElementById('meta');
  const res  = document.getElementById('results');

  /* ===== ユーティリティ ===== */
  const arr  = v => Array.isArray(v) ? v : (v ? [v] : []);
  const norm = s => (s||'').toString().toLowerCase();
  const tok  = s => { const t=(s||'').trim(); if(!t) return []; const sp=t.replace(/\s+/g,' ').split(' ').filter(Boolean); return sp.length?sp:[t]; };
  const esc  = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const hl   = (txt,ts)=>ts.reduce((r,t)=>r.replace(new RegExp('('+esc(t)+')','ig'),'<mark>$1</mark>'), txt);

  /* baseurlを確実に付けてPDF 404を防止 */
  const withBase = (p) => {
    if (!p) return null;
    if (/^https?:\/\//i.test(p)) return p;
    if (p.startsWith(base + '/')) return p;
    if (p.startsWith('/')) return base + p;
    return base + '/' + p.replace(/^\.\//,'');
  };

  /* ===== データ統合 ===== */
  const DATA = []
    .concat(arr(P).map(p=>({
      type:'公約',
      title:p.title||'',
      text:`${p.detail||''} ${p.status||''}`,
      date:p.last_update||'',
      url: base + '/pages/promise.html',
      pdf: withBase(p.pdf || null),
      tags: arr(p.tags).concat(arr(p.tag))
    })))
    .concat(arr(A).map(a=>({
      type:'活動',
      title:a.title||'',
      text:`${a.summary||''} ${a.category||''}`,
      date:a.date||'',
      url: base + '/pages/activity.html',
      pdf: withBase(a.pdf || null),
      tags: arr(a.tags).concat(arr(a.tag)).concat(arr(a.category))
    })))
    .concat(arr(M).flatMap(m=>{
      if(!m || !m.category) return [];
      const t1 = arr(m.sakio).map(x=>x.title||x.text||x).join(' ');
      const t2 = arr(m.related).map(x=>x.title||x.topic||x).join(' ');
      const pdf = (arr(m.sakio)[0] && arr(m.sakio)[0].pdf) ? arr(m.sakio)[0].pdf : (m.pdf || null);
      return [{
        type:'一般質問',
        title:m.category,
        text:(`${t1} ${t2}`).trim(),
        date:m.date||'',
        url: base + '/pages/matrix.html',
        pdf: withBase(pdf),
        tags:[m.category]
      }];
    }))
    .concat(POSTS.map(p=>({
      type:'活動（記事）',
      title:p.title||'',
      text:p.content||'',
      date:p.date||'',
      url:p.url,
      pdf:null,
      tags: arr(p.tags).concat(arr(p.categories))
    })));

  /* ===== 表示 ===== */
  function card(it,ts){
    const tags = (it.tags||[]).map(t =>
      `<a class="tagpill" data-tag="${t}" href="${base}/pages/tags.html#${encodeURIComponent(t)}">${t}</a>`
    ).join(' ');
    return `<article class="card" data-type="${it.type}">
      <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.35rem">
        <span class="badge" data-type="${it.type}">${it.type}</span>
        <span class="muted">${it.date||''}</span>
      </div>
      <h3>${hl(it.title,ts)}</h3>
      <p class="clamp-2">${hl(it.text||'',ts)}</p>
      ${tags?`<p>${tags}</p>`:''}
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:.25rem">
        ${it.pdf?`<a class="btn btn-primary pdf-link" href="${it.pdf}">PDFを開く</a>`:''}
        <a class="btn" href="${it.url}">該当ページ</a>
      </div>
    </article>`;
  }

  function score(it,ts){
    let s=0, T=norm(it.title), X=norm(it.text);
    for(const t0 of ts){ const t=norm(t0); if(!(T.includes(t)||X.includes(t))) return -1; s+=(T.includes(t)?3:0)+(X.includes(t)?1:0); }
    return s + (it.date?0.1:0);
  }

  function run(q){
    const ts = tok(q);
    if(!ts.length){ meta.textContent=`データ件数：${DATA.length}`; res.innerHTML=''; return; }
    const hits = DATA.map(it=>({it,s:score(it,ts)})).filter(x=>x.s>=0).sort((a,b)=>b.s-a.s);
    meta.textContent = `「${q}」の結果：${hits.length}件`;
    res.innerHTML = hits.map(h=>card(h.it,ts)).join('');
  }

  let timer;
  if(qEl){
    qEl.addEventListener('input',()=>{ clearTimeout(timer); timer=setTimeout(()=>run(qEl.value),120); });
  }
  const q = new URLSearchParams(location.search).get('q');
  if (q && qEl){ qEl.value=q; run(q); } else { meta.textContent=`データ件数：${DATA.length}`; }

})();
</script>
