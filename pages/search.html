---
layout: default
title: 検索
permalink: /pages/search.html
---

<h2>サイト内検索</h2>

<div class="card" style="margin-bottom:16px;">
  <input id="q" type="search" placeholder="キーワードを入力（例：給食 無償化 / 不登校 / 免許）"
         style="width:100%; padding:12px 14px; border:1px solid #ddd; border-radius:12px;">
  <div id="meta" style="margin-top:6px;color:#666;"></div>

  <!-- ▼ 追加：検索の仕様・コツを目に入る位置に -->
  <p class="search-note">
    ※ 日本語は、<strong>表記が違うとヒットしにくい</strong>です。<br>
    例）「きゅうしょく」ではなく <strong>「給食」</strong> などで、<strong> 検索</strong>してください。
  </p>
</div>
<script>
(function(){
  const base='{{ site.baseurl | default: "" }}';

  // /activity-site を確実に付ける
  const withBase = (p) => {
    if (!p) return null;
    if (/^https?:\/\//i.test(p)) return p;
    if (p.startsWith(base + '/')) return p;
    if (p.startsWith('/')) return base + p;
    return base + '/' + p.replace(/^\.\//,'');
  };

  // Liquid → JS は一重 json 化（undefined 安全化）
  {% assign P0 = site.data.promises.promises | default: site.data.promises %}
  {% assign A0 = site.data.activity.items   | default: site.data.activity %}
  {% assign M0 = site.data.matrix.rows      | default: site.data.matrix.categories | default: site.data.matrix %}

  const P = {{ P0 | jsonify }} || [];
  const A = {{ A0 | jsonify }} || [];
  const M = {{ M0 | jsonify }} || [];

  // _posts も検索対象
  const POSTS = [
    {% for post in site.posts %}
    {
      "title": {{ post.title | jsonify }},
      "url":   "{{ post.url | relative_url }}",
      "content": {{ post.content | strip_html | normalize_whitespace | jsonify }},
      "date":  "{{ post.date | date: '%Y-%m-%d' }}",
      "tags":  {{ post.tags | jsonify }},
      "categories": {{ post.categories | jsonify }}
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];

  // DOM
  const qEl  = document.getElementById('q');
  const meta = document.getElementById('meta');
  const res  = document.getElementById('results');

  // util
  const arr  = v => Array.isArray(v) ? v : (v ? [v] : []);
  const norm = s => (s==null?'':String(s)).toLowerCase();
  const tok  = s => { const t=(s||'').trim(); if(!t) return []; const sp=t.replace(/\s+/g,' ').split(' ').filter(Boolean); return sp.length?sp:[t]; };
  const esc  = s => String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  const hl   = (txt,ts)=>{
    let out = String(txt||'');
    for(const t0 of ts){
      const t = t0.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); // 正規表現エスケープ
      out = out.replace(new RegExp(`(${t})`,'ig'), '<mark>$1</mark>');
    }
    return out;
  };

  // データ結合（公約 / 活動 / 一般質問 / 記事）
  const DATA = []
    .concat(arr(P).map(p=>({
      type:'公約',
      title:p.title||'',
      text:`${p.detail||''} ${p.status||''}`,
      date:p.last_update||'',
      url: withBase('/pages/promise.html'),
      pdf: withBase(p.pdf || null),
      tags: arr(p.tags).concat(arr(p.tag))
    })))
    .concat(arr(A).map(a=>({
      type:'活動',
      title:a.title||'',
      text:`${a.summary||''} ${a.category||''}`,
      date:a.date||'',
      url: withBase('/pages/activity.html'),
      pdf: withBase(a.pdf || null),
      tags: arr(a.tags).concat(arr(a.tag)).concat(arr(a.category))
    })))
    .concat(arr(M).flatMap(m=>{
      if(!m || !m.category) return [];
      const sakioArr = arr(m.sakio);
      const relatedArr = arr(m.related);
      const t1=sakioArr.map(x=>x.title||x.text||x).join(' ');
      const t2=relatedArr.map(x=>x.title||x.topic||x).join(' ');
      const pdf = (sakioArr[0] && sakioArr[0].pdf) ? sakioArr[0].pdf : (m.pdf || null);
      return [{
        type:'一般質問',
        title:m.category,
        text:`${t1} ${t2}`.trim(),
        date:m.date||'',
        url: withBase('/pages/matrix.html'),
        pdf: withBase(pdf),
        tags:[m.category]
      }];
    }))
    .concat(POSTS.map(p=>({
      type:'活動（記事）',
      title:p.title||'',
      text:p.content||'',
      date:p.date||'',
      url:p.url, // relative_url 済み
      pdf:null,
      tags: arr(p.tags).concat(arr(p.categories))
    })));

  // AND 部分一致スコア
  function score(it,ts){
    let s=0, T=norm(it.title), X=norm(it.text);
    for(const t0 of ts){
      const t=norm(t0);
      if(!(T.includes(t)||X.includes(t))) return -1;      // AND 条件
      s+=(T.includes(t)?3:0)+(X.includes(t)?1:0);
    }
    return s + (it.date ? 0.1 : 0);
  }

  // 安全にカードHTML生成（例外で空になるのを防止）
  function card(it,ts){
    try{
      const tagHtml=(it.tags||[]).map(t=>`<a class="tagpill" data-tag="${esc(t)}" href="${withBase('/pages/tags.html')}#${encodeURIComponent(t)}">${esc(t)}</a>`).join(' ');
      return `<article class="card" data-type="${esc(it.type)}">
        <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.35rem">
          <span class="badge" data-type="${esc(it.type)}">${esc(it.type)}</span>
          <span class="muted">${esc(it.date||'')}</span>
        </div>
        <h3>${hl(esc(it.title),ts)}</h3>
        <p class="clamp-2">${hl(esc(it.text||''),ts)}</p>
        ${tagHtml?`<p>${tagHtml}</p>`:''}
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:.25rem">
          ${it.pdf?`<a class="btn btn-primary pdf-link" href="${it.pdf}">PDFを開く</a>`:''}
          <a class="btn" href="${it.url}">該当ページ</a>
        </div>
      </article>`;
    }catch(e){
      // フォールバック（最低限の表示を保証）
      return `<article class="card">
        <h3>${esc(it.title||'(無題)')}</h3>
        <p class="clamp-2">${esc((it.text||'').slice(0,140))}</p>
        <div><a class="btn" href="${esc(it.url||'#')}">該当ページ</a></div>
      </article>`;
    }
  }

  function renderHits(hits, ts){
    if(!hits.length){
      res.innerHTML = '<p class="muted">該当なし</p>';
      return;
    }
    const html = hits.map(h=>card(h.it,ts)).join('');
    // もし何らかの理由で空になった場合のフェイルセーフ
    res.innerHTML = html || hits.map(h=>`<div class="card"><h3>${esc(h.it.title||'(無題)')}</h3><a class="btn" href="${esc(h.it.url||'#')}">該当ページ</a></div>`).join('');
  }

  function run(q){
    try{
      const ts = tok(q);
      if (!ts.length){
        meta.textContent=`データ件数：${DATA.length}`;
        res.innerHTML='';
        history.replaceState(null,'', location.pathname);
        return;
      }
      const hits=DATA.map(it=>({it,s:score(it,ts)})).filter(x=>x.s>=0).sort((a,b)=>b.s-a.s);
      meta.textContent=`「${q}」の結果：${hits.length}件`;
      renderHits(hits, ts);
      history.replaceState(null,'', '?q='+encodeURIComponent(q));
    }catch(err){
      // 例外が出ても画面に情報を残す
      meta.textContent=`「${q}」の結果：処理中にエラーが発生しました`;
      res.innerHTML='<p class="muted">検索処理で問題が発生しました。入力を変えて再試行してください。</p>';
      // 開発時デバッグ用（コンソール確認）
      console.error('[search.run]', err);
    }
  }

  // 入力監視（デバウンス）
  let timer; qEl.addEventListener('input',()=>{ clearTimeout(timer); timer=setTimeout(()=>run(qEl.value),120); });

  // 直リンク ?q=
  const q=new URLSearchParams(location.search).get('q');
  if(q){ qEl.value=q; run(q); } else { meta.textContent=`データ件数：${DATA.length}`; }

  // 念のため表示を固定
  res.style.display = 'grid';
})();
</script>

