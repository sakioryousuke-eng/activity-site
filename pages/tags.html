---
layout: default
title: タグ
permalink: /pages/tags.html
---

<h2>タグ</h2>
<div class="card" id="tagCloud" style="margin-bottom:16px;"></div>
<div id="list" class="grid" role="list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;"></div>
<script>
(function(){
  const base='{{ site.baseurl | default: "" }}';
  const withBase = (p) => {
    if (!p) return null;
    if (/^https?:\/\//i.test(p)) return p;
    if (p.startsWith(base + '/')) return p;
    if (p.startsWith('/')) return base + p;
    return base + '/' + p.replace(/^\.\//,'');
  };
// 追加：同じ normalizeTags を tags.html にも入れる
const normalizeTags = (list) => {
  const arr = (Array.isArray(list) ? list : (list ? [list] : []))
    .map(t => (t ?? '').toString().replace(/\u3000/g,' ').replace(/\s+/g,' ').trim())
    .filter(Boolean);
  return [...new Set(arr)];
};
// 置換：items 生成内の「活動」ブロック
.concat(arr(A).map(a => ({
  type:'活動',
  title:a.title||'',
  text:a.summary||'',
  url: base+'/pages/activity.html',
  pdf: withBase(a.pdf || null),
  // ▼ tag / tags / category を統合して正規化
  tags: normalizeTags([...(a.tags||[]), ...(a.tag||[]), a.category||''])
})))

  {% assign P0 = site.data.promises.promises | default: site.data.promises %}
  {% assign A0 = site.data.activity.items   | default: site.data.activity %}
  {% assign M0 = site.data.matrix.rows      | default: site.data.matrix.categories | default: site.data.matrix %}

  const P = {{ P0 | jsonify }};
  const A = {{ A0 | jsonify }};
  const M = {{ M0 | jsonify }};

  const arr = v => Array.isArray(v) ? v : (v ? [v] : []);

  /* ▼ 全データ統合 */
  const items = []
    .concat(arr(P).map(p => ({
      type:'公約',
      title:p.title||'',
      text:p.detail||'',
      url: base+'/pages/promise.html',
      pdf: withBase(p.pdf || null),
      tags: arr(p.tags).concat(arr(p.tag)).filter(Boolean)
    })))
    .concat(arr(A).map(a => ({
      type:'活動',
      title:a.title||'',
      text:a.summary||'',
      url: base+'/pages/activity.html',
      pdf: withBase(a.pdf || null),
      tags: arr(a.tags).concat(arr(a.tag)).concat(arr(a.category)).filter(Boolean)
    })))
    .concat(arr(M).flatMap(m=>{
      if(!m||!m.category) return [];
      const sakioArr = arr(m.sakio);
      const relatedArr = arr(m.related);
      const t1 = sakioArr.map(x=>x.title||x.text||x).join(' ');
      const t2 = relatedArr.map(x=>x.title||x.topic||x).join(' ');
      const pdf = (sakioArr[0] && sakioArr[0].pdf) ? sakioArr[0].pdf : (m.pdf || null);
      return [{
        type:'一般質問',
        title:m.category,
        text:`${t1} ${t2}`.trim(),
        url: base+'/pages/matrix.html',
        pdf: withBase(pdf),
        tags:[m.category]
      }];
    }));

  /* ▼ 特定キーワードから「地域」「議会」「行政」タグを自動付与 */
  for(const it of items){
    const t = (it.text + ' ' + it.title).toLowerCase();
    if(/地域|住民|自治|まちづくり|交流|コミュニティ/.test(t)) it.tags.push('地域');
    if(/議会|質問|答弁|委員会|条例|審議/.test(t)) it.tags.push('議会');
    if(/行政|市役所|庁舎|公共|施策|計画/.test(t)) it.tags.push('行政');
  }

  /* ▼ タグ集計 */
  const tagMap = new Map();
  for(const it of items){
    const ts = it.tags && it.tags.length ? [...new Set(it.tags)] : ['未分類'];
    for(const t of ts){
      if(!tagMap.has(t)) tagMap.set(t,[]);
      tagMap.get(t).push(it);
    }
  }

  const tagCloud=document.getElementById('tagCloud');
  const list=document.getElementById('list');
  const tags=[...tagMap.entries()].sort((a,b)=>b[1].length-a[1].length);
  tagCloud.innerHTML =
    '<div style="display:flex;gap:8px;flex-wrap:wrap;">'
    + '<button class="btn" data-tag="*">すべて</button>'
    + tags.map(([t,arr])=>`<button class="btn" data-tag="${t}">${t}（${arr.length}）</button>`).join('')
    + '</div>';

 function render(tag){
  const arr = (tag==='*') ? items : (tagMap.get(tag)||[]);
  list.innerHTML = arr.map(it => `
    <article class="card" data-type="${it.type}">
      <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.35rem">
        <span class="badge" data-type="${it.type}">${it.type}</span>
      </div>
      <h3>${it.title}</h3>
      <p class="clamp-2">${it.text||''}</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:.25rem;">
        ${it.pdf ? `<a class="btn btn-primary pdf-link" href="${it.pdf}">PDFを開く</a>` : ''}
        <a class="btn" href="${it.url}">該当ページ</a>
        ${(it.tags||[]).map(t=>`<a class="tagpill" data-tag="${t}" href="${base}/pages/tags.html#${encodeURIComponent(t)}">${t}</a>`).join('')}
      </div>
    </article>
  `).join('');
}


  const currentHash = () => decodeURIComponent((location.hash||'').replace(/^#/,''));
  function selectByHash(){ const t=currentHash(); render(t && tagMap.has(t) ? t : '*'); }
  tagCloud.addEventListener('click',e=>{
    const b=e.target.closest('button[data-tag]'); if(!b) return;
    const t=b.getAttribute('data-tag');
    if(t==='*') history.replaceState(null,'',location.pathname);
    else location.hash=encodeURIComponent(t);
    selectByHash();
  });
  window.addEventListener('hashchange',selectByHash);
  selectByHash();
})();
</script>


