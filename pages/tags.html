---
layout: default
title: タグ
permalink: /pages/tags.html
---

<h2>タグ</h2>
<div class="card" id="tagCloud" style="margin-bottom:16px;"></div>
<div id="list" class="grid" role="list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;"></div>

<script>
(function(){
  const base='{{ site.baseurl | default: "" }}';
  const withBase = (p) => {
    if (!p) return null;
    if (/^https?:\/\//i.test(p)) return p;
    if (p.startsWith(base + '/')) return p;
    if (p.startsWith('/')) return base + p;
    return base + '/' + p.replace(/^\.\//,'');
  };
  const arr = v => Array.isArray(v) ? v : (v ? [v] : []);

  /* === _posts から活動データを生成（activity.yml は使わない） === */
  const POSTS = [
    {% assign posts = site.posts | sort: "date" | reverse %}
    {% for post in posts %}
      {
        type: '活動',
        title: {{ post.title | jsonify }},
        text: {{ post.excerpt | default: post.content | strip_html | strip_newlines | truncate: 160 | jsonify }},
        url: {{ post.url | relative_url | jsonify }},
        pdf: {{ post.pdf | default: nil | jsonify }},
        tags: ({{ post.tags | jsonify }} || []).concat({{ post.categories | jsonify }} || []),
        date: {{ post.date | date: "%Y-%m-%d" | jsonify }},
        image: {% if post.images and post.images.size > 0 %} {{ post.images[0] | relative_url | jsonify }} {% else %} null {% endif %}
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];

  /* === 任意：公約・一般質問（存在すれば併載） === */
  {% assign P0 = site.data.promises.promises | default: site.data.promises %}
  {% assign M0 = site.data.matrix.rows      | default: site.data.matrix.categories | default: site.data.matrix %}
  const P = {{ P0 | jsonify | default: '[]' }};
  const M = {{ M0 | jsonify | default: '[]' }};

  const promises = (Array.isArray(P) ? P : []).map(p => ({
    type:'公約',
    title:p.title||'',
    text:p.detail||'',
    url: withBase('/pages/promise.html'),
    pdf: withBase(p.pdf || null),
    tags: arr(p.tags).concat(arr(p.tag)).filter(Boolean)
  }));

  const matrix = (Array.isArray(M) ? M : []).flatMap(m=>{
    if(!m||!m.category) return [];
    const sakioArr = arr(m.sakio);
    const relatedArr = arr(m.related);
    const t1 = sakioArr.map(x=>x?.title||x?.text||x).join(' ');
    const t2 = relatedArr.map(x=>x?.title||x?.topic||x).join(' ');
    const pdf = (sakioArr[0] && sakioArr[0].pdf) ? sakioArr[0].pdf : (m.pdf || null);
    return [{
      type:'一般質問',
      title:m.category,
      text:`${t1} ${t2}`.trim(),
      url: withBase('/pages/matrix.html'),
      pdf: withBase(pdf),
      tags:[m.category]
    }];
  });

  /* ▼ 統合（活動は _posts 起点） */
  const items = []
    .concat(POSTS)
    .concat(promises)
    .concat(matrix);

  /* ▼ 自動タグ補強（主要3種） */
  for(const it of items){
    const t = ((it.text||'') + ' ' + (it.title||''));
    it.tags = arr(it.tags);
    if(/地域|住民|自治|まちづくり|交流|コミュニティ/.test(t)) it.tags.push('地域');
    if(/議会|質問|答弁|委員会|条例|審議/.test(t)) it.tags.push('議会');
    if(/行政|市役所|庁舎|公共|施策|計画/.test(t)) it.tags.push('行政');
  }

  /* ▼ タグ集計 */
  const tagMap = new Map();
  for(const it of items){
    const ts = it.tags && it.tags.length ? [...new Set(it.tags)] : ['未分類'];
    for(const tg of ts){
      if(!tagMap.has(tg)) tagMap.set(tg,[]);
      tagMap.get(tg).push(it);
    }
  }

  /* ▼ 表示用アイコン */
  const tagIcon = (t)=>{
    if(t==='地域') return '🌳';
    if(t==='議会') return '🏛️';
    if(t==='行政') return '⚙️';
    if(t==='公約') return '📌';
    if(t==='一般質問') return '❓';
    if(t==='活動') return '📝';
    return '🏷️';
  };

  /* ▼ UIレンダリング */
  const tagCloud=document.getElementById('tagCloud');
  const list=document.getElementById('list');
  const tags=[...tagMap.entries()].sort((a,b)=>b[1].length-a[1].length);

  function renderCloud(activeTag){
    const btn = (t,count)=>{
      const pressed = (activeTag===t) ? ' aria-pressed="true"' : '';
      return `<button class="tagbtn t-${cssSafe(t)}" data-tag="${escapeHtml(t)}"${pressed}><span class="ico">${tagIcon(t)}</span><span class="label">${t}</span><span class="num">（${count}）</span></button>`;
    };
    const total = items.length;
    const allPressed = (activeTag==='*'||!activeTag) ? ' aria-pressed="true"' : '';
    tagCloud.innerHTML =
      `<div class="tagbar">` +
      `<button class="tagbtn t-all" data-tag="*"${allPressed}><span class="ico">🗂️</span><span class="label">すべて</span><span class="num">（${total}）</span></button>` +
      tags.map(([t,arr]) => btn(t, arr.length)).join('') +
      `</div>`;
  }

  function card(it){
    const pills = (it.tags||[]).slice(0,6).map(t=>`<span class="tagpill" data-tag="${escapeHtml(t)}">${tagIcon(t)}&nbsp;${t}</span>`).join('');
    const img = it.image ? `<img src="${withBase(it.image)}" alt="" style="width:100%;height:auto;border-radius:8px;border:1px solid #eee;margin:.25rem 0">` : '';
    return `
      <article class="card">
        <div class="muted" style="font-size:.8rem;margin-bottom:.25rem">
          <span class="badge" data-type="${it.type}">${it.type}</span>
          ${it.date ? ` · <time>${it.date}</time>` : ''}
        </div>
        <h3 style="margin:.1em 0 .25em;font-size:1.05rem;line-height:1.35">${escapeHtml(it.title||'')}</h3>
        <p class="clamp-2">${escapeHtml(it.text||'')}</p>
        ${img}
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:.35rem;">
          ${it.pdf ? `<a class="btn btn-primary pdf-link" href="${it.pdf}">PDFを開く</a>` : ''}
          ${it.url ? `<a class="btn" href="${withBase(it.url)}">該当ページ</a>` : ''}
        </div>
        <div style="margin-top:.35rem">${pills}</div>
      </article>
    `;
  }

  function render(tag){
    const arr = (tag==='*'||!tag) ? items : (tagMap.get(tag)||[]);
    list.innerHTML = arr.map(card).join('');
    renderCloud(tag||'*');
  }

  /* ▼ クリック／ハッシュ連動 */
  tagCloud.addEventListener('click',e=>{
    const b=e.target.closest('button[data-tag]'); if(!b) return;
    const t=b.getAttribute('data-tag');
    if(t==='*') history.replaceState(null,'',location.pathname);
    else location.hash=encodeURIComponent(t);
    selectByHash();
  });

  const currentHash = () => decodeURIComponent((location.hash||'').replace(/^#/,''));
  function selectByHash(){
    const t=currentHash();
    render(t && tagMap.has(t) ? t : '*');
  }

  /* ▼ util */
  function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
  function cssSafe(s){return String(s).replace(/\s+/g,'-');}

  /* 初期表示 */
  selectByHash();
})();
</script>

<style>
:root{
  --fg:#0f172a;--muted:#64748b;--line:#e2e8f0;--chip:#f8fafc;
  --bg-card:#fff;--shadow:0 4px 16px rgba(0,0,0,.06);
  --type-公約:#155e75; --type-活動:#334155; --type-一般質問:#4f46e5;
  --tag-地域:#16a34a; --tag-議会:#2563eb; --tag-行政:#475569; --tag-未分類:#94a3b8;
}
.card{background:var(--bg-card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:none;transition:.2s box-shadow,.2s transform}
.card:hover{box-shadow:var(--shadow);transform:translateY(-1px)}
.card h3{margin:.1em 0 .25em;font-size:1.05rem;line-height:1.35}
.card p{margin:.4em 0;color:var(--fg)}
.muted{color:var(--muted)}

.badge{display:inline-flex;align-items:center;gap:.35em;font:600 .75rem/1.2 ui-sans-serif,system-ui;
  padding:.25em .6em;border-radius:999px;background:#eef2ff;color:#3730a3;border:1px solid #e0e7ff}
.badge[data-type="公約"]{background:#ecfeff;color:var(--type-公約);border-color:#cffafe}
.badge[data-type="活動"]{background:#eef2f7;color:var(--type-活動);border-color:#dbe3ee}
.badge[data-type="一般質問"]{background:#eef2ff;color:var(--type-一般質問);border-color:#e0e7ff}

/* タグピル（カード内） */
.tagpill{
  display:inline-flex;align-items:center;gap:.45em;padding:.3em .65em;border:1px solid var(--line);
  border-radius:999px;background:var(--chip);font:.8rem/1 ui-sans-serif,system-ui;color:var(--fg);
  text-decoration:none;vertical-align:middle
}
.tagpill::before{content:"";width:.6em;height:.6em;border-radius:999px;background:#94a3b8;flex:0 0 .6em;box-shadow:0 0 0 2px #fff inset}
.tagpill[data-tag="地域"]::before{background:var(--tag-地域)}
.tagpill[data-tag="議会"]::before{background:var(--tag-議会)}
.tagpill[data-tag="行政"]::before{background:var(--tag-行政)}
.tagpill[data-tag="地域"]{ border-color:#bbf7d0; background:#f0fdf4 }
.tagpill[data-tag="議会"]{ border-color:#bfdbfe; background:#eff6ff }
.tagpill[data-tag="行政"]{ border-color:#cbd5e1; background:#f1f5f9 }

.btn{border-radius:10px;border:1px solid var(--line);padding:.5em .8em;text-decoration:none}
.btn-primary{border-color:#93c5fd}
.clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
a:focus,button:focus{outline:3px solid #93c5fd;outline-offset:2px;border-radius:10px}

/* タグクラウドの色付きアイコンボタン */
.tagbar{display:flex;gap:8px;flex-wrap:wrap}
.tagbtn{
  display:inline-flex;align-items:center;gap:.45em;padding:.45em .9em;border:1px solid var(--line);
  border-radius:999px;background:#fff;color:#111;text-decoration:none;cursor:pointer;font:600 .9rem/1 ui-sans-serif,system-ui
}
.tagbtn .ico{font-size:1.05rem;line-height:1}
.tagbtn .num{color:var(--muted);font-weight:600}
.tagbtn[aria-pressed="true"]{box-shadow:0 0 0 3px rgba(99,102,241,.15) inset;border-color:#c7d2fe;background:#eef2ff}

/* 色バリエーション（主要3種＋その他） */
.t-地域{ border-color:#bbf7d0; background:#f0fdf4; }
.t-議会{ border-color:#bfdbfe; background:#eff6ff; }
.t-行政{ border-color:#cbd5e1; background:#f1f5f9; }
.t-未分類{ border-color:#e5e7eb; background:#f9fafb; }
.t-all{ border-color:#e5e7eb; background:#ffffff; }

button.tagbtn{min-height:38px}
</style>
