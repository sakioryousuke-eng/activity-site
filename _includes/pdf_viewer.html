<!-- 共通PDFモーダル：公約の“見え方”を再現（zoom=50・上下左右safe-area対応） -->
<dialog id="pdfModal" aria-label="PDFを表示">
  <div class="pdf-head">
    <strong id="pdfTitle">PDF</strong>
    <button id="pdfClose" aria-label="閉じる">×</button>
  </div>
  <div class="pdf-body">
    <iframe id="pdfFrame" title="PDF表示" loading="lazy" referrerpolicy="no-referrer"></iframe>
  </div>
</dialog>

<style>
/* 全画面＆安全領域対応（右・下の見切れを根治） */
#pdfModal{
  position:fixed; inset:0; margin:0; padding:0; border:none; background:#fff;
  width:100vw; max-width:100vw; height:100svh; border-radius:0; overflow:hidden;
  /* 実計測したヘッダー高をCSS変数で受ける（端末差・回転に強い） */
  --pdf-head-h: 64px;
}
@supports not (height:100svh){ #pdfModal{ height:100dvh; } }
#pdfModal::backdrop{ background:rgba(0,0,0,.35); }

/* ヘッダー：上＋左右のsafe-areaを考慮（iOSノッチ/サイド対策） */
#pdfModal .pdf-head{
  display:flex; justify-content:space-between; align-items:center;
  background:#fff; border-bottom:1px solid #eee;
  padding:.7rem .9rem;
  padding-top:calc(.7rem + env(safe-area-inset-top));
  padding-left:calc(.9rem + env(safe-area-inset-left));
  padding-right:calc(.9rem + env(safe-area-inset-right));
  min-height:48px;
}
#pdfModal .pdf-head button{
  border:none; background:#fff; font-size:1.1rem; line-height:1;
  border-radius:8px; padding:.3rem .5rem; cursor:pointer;
}

/* 本体：上下左右のsafe-area＋ヘッダー高を正確に反映（“右・下の見切れ”防止） */
#pdfModal .pdf-body{
  position:absolute;
  top: var(--pdf-head-h);
  left: env(safe-area-inset-left);
  right: env(safe-area-inset-right);
  bottom: env(safe-area-inset-bottom);
  background:#fff; overflow:hidden; margin:0;
  /* スワイプで裏のページが動かないように */
  overscroll-behavior: contain;
}

/* ビューアは余白ゼロで全面表示（旧Safariの余白バグにも対応） */
#pdfFrame{
  display:block; width:100%; height:100%; border:0; background:#fff;
  height:-webkit-fill-available;
}

/* モーダル中は背面スクロール不可（縦横スライド抑止） */
html.__pdflock, body.__pdflock{ overflow:hidden; }
</style>

<script>
(function(){
  const dlg   = document.getElementById('pdfModal');
  const frame = document.getElementById('pdfFrame');
  const title = document.getElementById('pdfTitle');
  const head  = dlg.querySelector('.pdf-head');
  const btn   = document.getElementById('pdfClose');

  // 公約と同じ初期ズーム＆UI抑制
  function toZoom50(href){
    try{
      const url = new URL(href, location.href);
      const sp  = new URLSearchParams(url.hash.replace(/^#/,''));
      sp.set('zoom','50'); sp.set('toolbar','0'); sp.set('navpanes','0');
      url.hash = sp.toString();
      return url.toString();
    }catch(_){
      return href + (href.includes('#') ? '&' : '#') + 'zoom=50&toolbar=0&navpanes=0';
    }
  }

  // 端末・回転・フォント差でヘッダー高が変わるのを実測で吸収
  function applyHeadHeight(){
    const h = Math.ceil(head.getBoundingClientRect().height);
    dlg.style.setProperty('--pdf-head-h', h + 'px');
  }

  function openPdf(href, ttl){
    title.textContent = ttl || 'PDF';
    frame.src = toZoom50(href);
    applyHeadHeight();
    document.documentElement.classList.add('__pdflock');
    document.body.classList.add('__pdflock');
    dlg.showModal();
  }

  function closePdf(){
    frame.src = 'about:blank';
    dlg.close();
    document.documentElement.classList.remove('__pdflock');
    document.body.classList.remove('__pdflock');
  }

  btn.addEventListener('click', closePdf);
  dlg.addEventListener('close', closePdf);
  window.addEventListener('resize', ()=>{ if(dlg.open) applyHeadHeight(); });
  window.addEventListener('orientationchange', ()=>{ if(dlg.open) applyHeadHeight(); });

  // data-modal="pdf" へのイベント委任（公約と同じ運用）
  document.addEventListener('click', function(e){
    const a = e.target.closest('a[data-modal="pdf"]');
    if(!a) return;
    e.preventDefault();
    openPdf(a.getAttribute('href'), a.dataset.title || 'PDF');
  }, {passive:false});
})();
</script>
